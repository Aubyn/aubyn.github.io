import{l as s,c as a,b as e,aj as n}from"./chunks/framework.CZoYd-ur.js";const c=JSON.parse('{"title":"Traefik","description":"","frontmatter":{},"headers":[],"relativePath":"blog/cheetsheet/traefik.md","filePath":"blog/cheetsheet/traefik.md"}'),l={name:"blog/cheetsheet/traefik.md"};function t(h,i,r,p,o,k){return e(),a("div",null,[...i[0]||(i[0]=[n(`<h1 id="traefik" tabindex="-1">Traefik <a class="header-anchor" href="#traefik" aria-label="Permalink to &quot;Traefik&quot;">​</a></h1><h2 id="why" tabindex="-1">why <a class="header-anchor" href="#why" aria-label="Permalink to &quot;why&quot;">​</a></h2><p>很多时候，需要在一个域名 <code>example.com</code> 底下关联很多服务，这样用户使用各服务的时候都知道它属于 <code>example</code>，强化了品牌认知。</p><p>同域名关联多服务，一种方式是使用子域名 <code>doc.example.com</code>，另一种方式是使用子路径 <code>example.com/doc</code>。</p><p>通过服务发现和反向代理路由，Traefik 很好地实现了上述能力。</p><h2 id="how" tabindex="-1">how <a class="header-anchor" href="#how" aria-label="Permalink to &quot;how&quot;">​</a></h2><h3 id="○-scenario-通用反向代理路由" tabindex="-1">○ scenario 通用反向代理路由 <a class="header-anchor" href="#○-scenario-通用反向代理路由" aria-label="Permalink to &quot;○ scenario 通用反向代理路由&quot;">​</a></h3><ul><li>given 真正处理请求的服务启动（对应 Traefik 中的 Services 概念）</li><li>and 反向代理规则配置（请求 -&gt; 真正服务）（对应 Traefik 中的 Providers 和 Routes 概念）</li><li>and 反向代理服务器启动（Traefik）</li><li>when 用户请求到反向代理服务器（Traefik Endpoints 入口接收）</li><li>then 反向代理服务器分析请求</li><li>when 请求匹配某个路由规则</li><li>then 将请求转发到路由规则对应的真正服务</li></ul><h3 id="○-scenario-启动-traefik" tabindex="-1">○ scenario 启动 Traefik <a class="header-anchor" href="#○-scenario-启动-traefik" aria-label="Permalink to &quot;○ scenario 启动 Traefik&quot;">​</a></h3><ul><li>given 系统中 docker 可用</li><li>and 添加 Traefik 启动对应的 docker-compose.yml</li><li>when 执行 <code>docker-compose up -d</code></li><li>then 启动 Traefik（占用对应端口）</li><li>when 浏览器中打开 dashboard 地址（<code>http://localhost:8180/dashboard/</code>）</li><li>then 查看 Traefik 运行状态</li></ul><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># docker-compose.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  traefik</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">traefik:v3.6</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--api.insecure=true&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 不安全模式，无需身份认证即可访问仪表盘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--providers.docker=true&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--entrypoints.web.address=:80&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # http endpoint</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # - &quot;--entryPoints.websecure.address=:443&quot; # https endpoint</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # - &quot;--entryPoints.websecure.http.tls=true&quot; # https</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8100:80&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # endpoint</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8180:8080&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # dashboard</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/docker.sock:/var/run/docker.sock</span></span></code></pre></div><h3 id="○-scenario-根据请求头-host-分流到新服务" tabindex="-1">○ scenario 根据请求头 Host 分流到新服务 <a class="header-anchor" href="#○-scenario-根据请求头-host-分流到新服务" aria-label="Permalink to &quot;○ scenario 根据请求头 Host 分流到新服务&quot;">​</a></h3><ul><li>given Traefik 已启动</li><li>and 添加新服务对应配置 whoami.yml，其中分流标签为 <code>Host(\`whoami.localhost\`)</code></li><li>when 执行 <code>docker-compose -f whoami.yml up -d</code></li><li>then 新服务启动</li><li>when 执行 <code>curl -H &quot;Host: whoami.localhost&quot; http://localhost:8100</code></li><li>then 得到响应结果，证明已被 Traefik 路由成功</li><li>when 浏览器进入 Traefik 面板的 HTTP 页面</li><li>then 看到新服务及其路由规则展示</li></ul><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># whoami.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  whoami</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">traefik/whoami</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;traefik.http.routers.whoami.rule=Host(\`whoami.localhost\`)&quot;</span></span></code></pre></div><h3 id="○-scenario-根据子路径分流到新服务" tabindex="-1">○ scenario 根据子路径分流到新服务 <a class="header-anchor" href="#○-scenario-根据子路径分流到新服务" aria-label="Permalink to &quot;○ scenario 根据子路径分流到新服务&quot;">​</a></h3><ul><li>given Traefik 已启动</li><li>and 添加新服务对应配置 whoami.yml，其中分流标签为 <code>PathPrefix(\`/whoami\`)</code></li><li>when 执行 <code>docker-compose -f whoami.yml up -d</code></li><li>then 新服务启动</li><li>when 执行 <code>curl -H &quot;curl http://localhost:8100/whoami</code></li><li>then 得到响应结果，证明已被 Traefik 路由成功</li><li>when 浏览器进入 Traefik 面板的 HTTP 页面</li><li>then 看到新服务及其路由规则展示</li></ul><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># whoami.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  whoami</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">traefik/whoami</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;traefik.http.routers.whoami.rule=PathPrefix(\`/whoami\`)&quot;</span></span></code></pre></div><p><strong>⏳scenario 请求鉴权</strong></p><ul><li>given 鉴权服务启动（通过响应码来判断鉴权是否成功）</li><li>and 添加 ForwardAuth 中间件到 Traefik 中</li></ul><p><strong>⏳scenario 启动 Traefik 为 https 服务</strong></p><p><strong>⏳scenario 性能监控</strong></p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/middlewares/overview/" target="_blank" rel="noreferrer">Traefik 中间件</a></li><li><a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/routing/multi-layer-routing/" target="_blank" rel="noreferrer">Traefik 多层路由</a></li></ul>`,23)])])}const E=s(l,[["render",t]]);export{c as __pageData,E as default};
